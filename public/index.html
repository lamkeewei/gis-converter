<!DOCTYPE html>
<html lang="EN">
  <head>
    <title>GIS Converter</title>
    <meta charset=utf-8>
    <meta name=description content="">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet" media="screen">
  </head>
  <body ng-app="myApp">
    <div class="container" ng-controller="MainCtrl">
      <div class="row">
        <div class="col-md-12">
          <div class="page-header">
            <h1>Shapefile to GeoJSON</h1>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-8">
          <form name="uploadForm" ng-submit="uploadFile()" class="form-horizontal" novalidate>
            <div class="form-group">
              <label class="control-label col-md-4">File: </label>
              <div class="col-md-8">
                <input type="file" ng-file-select="onFileSelect($files)" required/>
                <p class="help-block">Zip up the files that you want to convert. It should minimally contain ".shp", ".shx" and ".dbf" files. Example: <a href="https://dl.dropboxusercontent.com/u/18536100/Education.zip">here</a></p>
              </div>

            </div>

            <div class="form-group">
              <label class="control-label col-md-4">Source CRS: </label>
              <div class="col-md-8">
                <input type="text" class="form-control" placeholder="Eg. EPSG:3414" ng-model="crs" required/>
              </div>
            </div>

            <div class="form-group">
              <div class="col-md-offset-4 col-md-8">
                <input type="submit" class="btn btn-success" />
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <pre>{{reply}}</pre>
        </div>
      </div>
    </div>
    <!-- jQuery -->
    <script src="//code.jquery.com/jquery.js"></script>
    <!-- Bootstrap JavaScript -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <script src="components/ng-file-upload/angular-file-upload-html5-shim.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.10/angular.min.js"></script>
    <script src="components/ng-file-upload/angular-file-upload.min.js"></script>
    <script type="text/javascript">
      var app = angular.module('myApp', ['angularFileUpload']);

      app.controller('MainCtrl', ['$scope', '$upload', function($scope, $upload){
        $scope.reply ='Hello! Choose a zipfile and a CRS to get started! :D';
        $scope.selectedFile = [];

        $scope.onFileSelect = function($files){
          $scope.selectedFile = $files;
        }

        $scope.uploadFile = function() {
          $files = $scope.selectedFile;

          if($files.length === 0 || $scope.uploadForm.$invalid){
            alert('Fill in all fields!');
            return;
          }

          for (var i = 0; i < $files.length; i++) {
            var file = $files[i];
            $scope.upload = $upload.upload({
              url: 'convert/' + $scope.crs, 
              method: 'POST',
              file: file
            }).progress(function(evt) {
              console.log('percent: ' + parseInt(100.0 * evt.loaded / evt.total));
            }).success(function(data, status, headers, config) {
              $scope.reply = JSON.stringify(data, undefined, 2);
              console.log(data);
            });
          }
        };
      }]);
    </script>
  </body>
</html>